<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç —á–∞—Ç–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 20px;
        }
        #chat-messages {
            border: 2px solid #9146ff;
            border-radius: 10px;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.1);
        }
        .message {
            margin-bottom: 5px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        .username {
            color: #9146ff;
            font-weight: bold;
        }
        .text {
            color: white;
        }
        .system-message {
            color: #ffd700;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç Twitch —á–∞—Ç–∞</h1>
    <div id="chat-messages"></div>
    
    <script>
        class SimpleTwitchChat {
            constructor() {
                this.socket = null;
                this.channel = 'moonaticks'; // –ö–∞–Ω–∞–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                this.isConnected = false;
                this.chatMessagesElement = document.getElementById('chat-messages');
                
                this.init();
            }
            
            init() {
                this.addSystemMessage('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞...');
                this.connectToChat();
            }
            
            connectToChat() {
                this.addSystemMessage(`üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–∞–Ω–∞–ª—É ${this.channel}...`);
                
                try {
                    this.socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
                    
                    this.socket.onopen = () => {
                        console.log('Connected to Twitch IRC');
                        this.addSystemMessage('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ Twitch IRC');
                        
                        // –ê–Ω–æ–Ω–∏–º–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                        this.socket.send('PASS blah\r\n');
                        this.socket.send('NICK justinfan' + Math.floor(Math.random() * 99999) + '\r\n');
                        this.socket.send('CAP REQ :twitch.tv/commands twitch.tv/tags\r\n');
                        this.socket.send('JOIN #' + this.channel + '\r\n');
                    };
                    
                    this.socket.onmessage = (event) => {
                        console.log('Raw IRC message:', event.data);
                        this.parseMessage(event.data);
                    };
                    
                    this.socket.onclose = () => {
                        this.isConnected = false;
                        this.addSystemMessage('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å IRC –∑–∞–∫—Ä—ã—Ç–æ');
                    };
                    
                    this.socket.onerror = (error) => {
                        console.error('IRC error:', error);
                        this.addSystemMessage('‚ùå –û—à–∏–±–∫–∞ IRC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                    };
                    
                } catch (error) {
                    console.error('Connection error:', error);
                    this.addSystemMessage('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
                }
            }
            
            parseMessage(data) {
                const lines = data.split('\r\n');
                
                lines.forEach(line => {
                    if (!line) return;
                    
                    console.log('Processing line:', line);
                    
                    if (line.includes('PING')) {
                        this.socket.send('PONG :tmi.twitch.tv\r\n');
                        return;
                    }
                    
                    if (line.includes('JOIN #' + this.channel)) {
                        this.isConnected = true;
                        this.addSystemMessage(`‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–∞–Ω–∞–ª—É #${this.channel}`);
                        return;
                    }
                    
                    if (line.includes('PRIVMSG #' + this.channel)) {
                        this.parsePrivMsg(line);
                    }
                });
            }
            
            parsePrivMsg(line) {
                console.log('Parsing PRIVMSG:', line);
                
                // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ PRIVMSG
                const parts = line.split(' ');
                const userPart = parts[0];
                const messagePart = line.split(' :').slice(1).join(' :');
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                let username = 'unknown';
                if (userPart.includes('!')) {
                    username = userPart.split('!')[0].replace(':', '');
                }
                
                this.addChatMessage(username, messagePart);
            }
            
            addChatMessage(username, text) {
                console.log('Adding chat message:', username, text);
                
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.innerHTML = `
                    <span class="username">${this.escapeHtml(username)}:</span>
                    <span class="text">${this.escapeHtml(text)}</span>
                `;
                
                this.chatMessagesElement.appendChild(messageElement);
                this.chatMessagesElement.scrollTop = this.chatMessagesElement.scrollHeight;
            }
            
            addSystemMessage(text) {
                console.log('Adding system message:', text);
                
                const messageElement = document.createElement('div');
                messageElement.className = 'message system-message';
                messageElement.innerHTML = `<span class="text">${this.escapeHtml(text)}</span>`;
                
                this.chatMessagesElement.appendChild(messageElement);
                this.chatMessagesElement.scrollTop = this.chatMessagesElement.scrollHeight;
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞
        document.addEventListener('DOMContentLoaded', () => {
            new SimpleTwitchChat();
        });
    </script>
</body>
</html>
